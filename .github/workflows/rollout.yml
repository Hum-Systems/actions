on:
  workflow_call:
    secrets:
      KUBE_CONFIG:
        required: true
      GOOGLE_CHAT_WEBHOOK:
        required: true
    inputs:
      tag:
        type: string
        description: 'The tag that was deployed if its not equal to environment'
      environment:
        type: string
        description: 'The target deployment environment'
        required: true
      deployment_name:
        type: string
        description: 'The name of the Kubernetes deployment to rollout-restart'
        required: false
        default: ${{ github.event.repository.name }}
      image-name:
        type: string
        description: 'Name of the genereated docker image'
        required: false
        default: ${{ github.repository }}

name: Rollout

jobs:
  rollout:
    name: Rollout
    runs-on: ubuntu-latest
    steps:
      - name: Rollout
        uses: steebchen/kubectl@v2.0.0
        with:
          config: ${{ secrets.KUBE_CONFIG }}
          command: rollout restart deployment/${{ inputs.deployment_name }}
      - name: Compute Tag
        uses: ASzc/change-string-case-action@v1
        id: tag
        with:
          string: ${{ format('ghcr.io/{0}:{1}', image-name, (inputs.tag || inputs.environment)) }}
      - name: Compute Status
        uses: ASzc/change-string-case-action@v1
        id: status
        with:
          string: ${{ job.status }}
      - name: Compute Environment
        uses: ASzc/change-string-case-action@v1
        id: env
        with:
          string: ${{ inputs.environment }}
      - name: Send Google Chat Notification
        run: |
          curl \
            --location \
            --request POST '${{ secrets.GOOGLE_CHAT_WEBHOOK }}' \
            --header 'Content-Type: application/json' \
            --data-raw '{
              "cards": [
                {
                  "header": {
                    "title": "ðŸ“¢ ${{ steps.env.outputs.capitalized }} Deployment",
                    "subtitle": "${{ github.event.repository.name }} was deployed to ${{ inputs.environment }}"
                  },
                  "sections": [
                    {
                      "widgets": [
                        {
                          "keyValue": {
                            "icon": "INVITE",
                            "topLabel": "Status",
                            "content": "${{ steps.status.outputs.capitalized }}"
                          }
                        },
                        {
                          "keyValue": {
                            "icon": "BOOKMARK",
                            "topLabel": "Tag",
                            "content": "${{ steps.tag.outputs.lowercase }}"
                          }
                        },
                        {
                          "keyValue": {
                            "icon": "DESCRIPTION",
                            "topLabel": "Commit",
                            "content": "${{ github.event.head_commit.message }}",
                            "bottomLabel": "${{ github.event.head_commit.id }}",
                            "onClick": {
                              "openLink": {
                                "url": "${{ github.event.head_commit.url }}"
                              }
                            }
                          }
                        },
                        {
                          "keyValue": {
                            "iconUrl": "${{ github.event.sender.avatar_url }}",
                            "topLabel": "Author",
                            "content": "${{ github.event.sender.login }}",
                            "onClick": {
                              "openLink": {
                                "url": "${{ github.event.sender.html_url }}"
                              }
                            }
                          }
                        },
                        {
                          "buttons": [
                            {
                              "textButton": {
                                "text": "VIEW",
                                "onClick": {
                                  "openLink": {
                                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}}"
                                  }
                                }
                              }
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }'
