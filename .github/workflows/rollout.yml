on:
  workflow_call:
    secrets:
      GOOGLE_CHAT_WEBHOOK:
        required: true
    inputs:
      environment:
        type: string
        description: 'The target deployment environment'
        required: true

name: Rollout

jobs:
  rollout:
    name: Rollout
    runs-on: ubuntu-latest
    steps:
      - name: Rollout
        run: |
          echo "kubectl rollout restart deployment/foo"
  notify:
    name: Notify
    runs-on: ubuntu-latest
    env: 
      message: '{
        "cards": [
          {
            "header": {
              "title": "ðŸ“¦ Deployment",
              "subtitle": "${{ github.event.repository.name }} was deployed to ${{ inputs.environment }}"
            },
            "sections": [
              {
                "widgets": [
                  {
                    "keyValue": {
                      "icon": "INVITE",
                      "topLabel": "Status",
                      "content": "${{ job.status }}"
                    }
                  },
                  {
                    "keyValue": {
                      "icon": "BOOKMARK",
                      "topLabel": "Tag",
                      "content": "${{ needs.build.outputs.tag }}"
                    }
                  },
                  {
                    "keyValue": {
                      "icon": "DESCRIPTION",
                      "topLabel": "Commit",
                      "content": "${{ github.event.head_commit.message }}",
                      "bottomLabel": "${{ github.event.head_commit.id }}",
                      "onClick": {
                        "openLink": {
                          "url": "${{ github.event.head_commit.url }}"
                        }
                      }
                    }
                  },
                  {
                    "keyValue": {
                      "iconUrl": "${{ github.event.sender.avatar_url }}",
                      "topLabel": "Author",
                      "content": "${{ github.event.sender.login }}",
                      "onClick": {
                        "openLink": {
                          "url": "${{ github.event.sender.html_url }}"
                        }
                      }
                    }
                  },
                  {
                    "buttons": [
                      {
                        "textButton": {
                          "text": "VIEW",
                          "onClick": {
                            "openLink": {
                              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}}"
                            }
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }'
    steps:
      - name: Send Google Chat Notification
        run: |
          curl
            --location \
            --request POST '${{ secrets.GOOGLE_CHAT_WEBHOOK }}' \
            --header 'Content-Type: application/json' \
            --data-raw ${{ inputs.message }}
